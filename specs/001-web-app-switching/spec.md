# Feature Specification: 多 Web 应用切换与状态保留

**Feature Branch**: `001-web-app-switching`  
**Created**: 2025-12-21  
**Status**: Draft  
**Input**: User description: "应用可以添加多个 web 程序，且可以随意切换。切换时要保留 web 应用的状态。详细功能可以参考 github 开源项目 https://github.com/deepshit2025/tuboshu"

## User Scenarios & Testing *(mandatory)*

本功能围绕“把多个 Web 应用加入到桌面容器里，并能随时切换且保留状态”展开。

### User Story 1 - 添加 Web 应用到应用库 (Priority: P1)

用户在桌面容器中新增一个 Web 应用（提供名称与入口 URL），并能从应用库中打开它。

**Why this priority**: 没有“添加/管理 Web 应用”，就无法形成多应用切换的基础。

**Independent Test**: 新增一个 Web 应用条目后，能在应用库中看到并成功打开，且配置可被持久保存。

**Acceptance Scenarios**:

1. **Given** 应用库为空，**When** 用户新增一个 Web 应用并保存，**Then** 应用库出现该条目且可点击打开
2. **Given** 应用库已有多个 Web 应用，**When** 用户编辑其中一个的名称或入口 URL 并保存，**Then** 变更后信息正确展示且下次启动仍保留

---

### User Story 2 - 在多个 Web 应用之间切换并保留状态 (Priority: P2)

用户同时打开多个 Web 应用，切换时每个应用保持自己的浏览位置与登录状态，不会被刷新到初始页。

**Why this priority**: “切换保留状态”是该功能的核心价值，决定用户是否把它当作真正的桌面应用容器来使用。

**Independent Test**: 打开两个 Web 应用，各自导航到不同页面并进行一次可见状态变化（如输入框内容或登录后页面），来回切换后状态保持不变。

**Acceptance Scenarios**:

1. **Given** 用户打开了 Web 应用 A 并导航到某页面，**When** 用户切换到 Web 应用 B 再切回 A，**Then** A 仍停留在切换前页面且无需重新登录
2. **Given** 用户在 Web 应用 A 中填写了未提交的表单内容，**When** 用户切换到 Web 应用 B 再切回 A，**Then** 表单内容仍在且页面未被重载

---

### User Story 3 - 记住工作区并在下次启动恢复 (Priority: P3)

用户关闭桌面容器后再次打开，希望继续上一次使用的 Web 应用与页面状态（至少恢复到上次活跃的应用与页面）。

**Why this priority**: 这是提升“桌面应用感”的关键补充，减少重复打开与定位成本。

**Independent Test**: 打开并切换多个 Web 应用后退出应用，再次启动后自动恢复上次活跃应用（以及其上次页面）。

**Acceptance Scenarios**:

1. **Given** 用户上次退出前活跃的是 Web 应用 A，**When** 用户重新启动应用，**Then** 默认进入 Web 应用 A 且处于上次退出前的页面或等价恢复状态

---

### Edge Cases

- 新增 Web 应用时 URL 非法、为空或不是可打开的链接
- Web 应用入口不可达/超时，或在运行中断网
- Web 应用跳转到不允许的域名或试图打开外部协议（例如自定义 scheme）
- 用户删除某个 Web 应用时，该应用当前正在运行/处于活跃状态
- 同时打开很多 Web 应用导致资源紧张：系统需要明确“状态可能被暂停/回收”的表现与恢复方式

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统 MUST 允许用户新增多个 Web 应用条目，每个条目至少包含名称与入口 URL
- **FR-002**: 系统 MUST 允许用户查看应用库列表，并打开任意一个已添加的 Web 应用
- **FR-003**: 系统 MUST 允许用户编辑与删除已添加的 Web 应用；删除必须有确认步骤
- **FR-004**: 系统 MUST 支持在多个 Web 应用之间随意切换，切换时 MUST 保留每个 Web 应用的运行状态（包括当前页面与会话状态），且不得强制刷新为入口页
- **FR-005**: 系统 MUST 在切换回某个 Web 应用时，将用户带回到上次切换时该应用的可见状态（例如页面位置与未提交输入内容仍存在）
- **FR-006**: 系统 MUST 对不同 Web 应用进行数据隔离（例如会话/存储/缓存隔离），默认不得发生跨应用的数据共享
- **FR-007**: 系统 MUST 为每个 Web 应用提供可配置的“允许访问的域名范围”，并在 Web 内容尝试访问范围外域名时采取明确策略（阻止或交由系统打开，并对用户可见）
- **FR-008**: 系统 MUST 记住上次退出前的工作区（至少：上次活跃的 Web 应用与其最后可见页面），并在下次启动时恢复
- **FR-009**: 系统 MUST 提供用户可执行的数据清理能力（按单个 Web 应用清理其数据，或清理全部），以满足隐私与故障排查需求
- **FR-010**: 系统 MUST 记录与切换/导航策略相关的关键事件，便于问题复现与定位（记录内容需允许用户关闭或清理）
- **FR-011**: 系统 SHOULD 提供“沉浸模式（仅显示网页内容）”，进入后隐藏顶部栏与侧边栏；提供菜单开关与快捷键（建议：Cmd/Ctrl+Shift+M）以及顶栏按钮以便快速切换
- **FR-012**: 系统 SHOULD 提供“系统语言”设置（至少：跟随系统、简体中文、英文），设置需持久化并通过事件广播到渲染层（为后续 i18n 留钩子）

### Assumptions

- 默认以“单个主窗口 + 应用库切换”的方式呈现；是否支持多窗口属于后续扩展范围
- “保留状态”优先保证在同一次运行中的切换不丢失；跨重启的恢复以“用户可感知的等价恢复”作为验收标准

### UI Shell Notes

- 主窗口中的 Web 内容通过 `BrowserView` 承载；所有设置/管理界面应避免与 `BrowserView` 发生层级覆盖冲突。
- 设置以“左侧抽屉覆盖层”的方式呈现（推荐实现为叠加 `BrowserView`），打开时不应挤压/重排 Web 内容区域；抽屉宽度需保证内容完整显示（实现可设为约 560px）。
- 顶部栏（TopBar）高度建议固定为 38px，并同步到 `BrowserView` 的 `bounds.y`，避免点击区域与视觉错位。
- 外链策略/允许域名修改需对“运行中的 WebAppView”即时生效（不要求用户重启或手动刷新）。
- OAuth 等授权登录场景：当外链策略为 `open-in-popup` 时，应允许外部域名通过 `window.open` 在应用内弹窗打开（保留 opener 语义），并在弹窗导航回允许域名时支持回跳主 WebView（best-effort）。
- macOS 视觉效果：主窗口建议开启 `vibrancy: under-window` + `transparent`，UI 使用半透明材质色值（配合 `backdrop-filter`）以获得统一的毛玻璃体验。
- 启动体验：当工作区无可恢复的活跃应用时，默认打开“应用管理”列表中的第一个应用作为初始活跃应用。
- 新窗口策略：对允许域名内的 `window.open`，默认在当前 WebView 内打开（避免首次进入站点弹出多余窗口）；仅对外域（且策略为 `open-in-popup`）允许创建弹窗窗口。
- 弹窗防打扰：对外域弹窗（`window.open` / 外链策略 `open-in-popup`），默认要求近期用户手势（点击/键盘）才允许，避免应用冷启动时站点自动弹窗。
- 应用分组：WebAppProfile 支持可选 `group` 字段；侧边栏与应用管理按分组展示（未设置分组视为“未分组”）。
- 顶部栏分组切换：TopBar 提供“分组 Select（全部/各分组）”，用于快速在分组之间切换并聚焦显示该分组的固定应用。为避免与 macOS 交通灯重叠，Select 需放在左侧预留区域，并在 macOS 上增加左侧 padding（例如 88px）。视觉样式与顶栏一致（透明背景、无边框）。
- 侧边栏按分组分段显示，分组之间使用细分割线分隔（仅“全部分组”视图下显示）。
- 沉浸模式：隐藏顶栏与侧边栏，仅显示 Web 内容；提供菜单项与顶栏按钮，支持快捷键（Cmd/Ctrl+Shift+M）。切换后需同步 `BrowserView` 布局尺寸。
- 新窗口策略微调：对 `did-create-window` 若目标最终 URL 属于允许域名，则应在主视图内打开并关闭子窗口；仅对外域按策略（如 `open-in-popup`）以弹窗呈现。
- 拖拽排序：设置页“应用管理”列表支持拖拽排序（固定/未固定均可）；固定应用的顺序回写到 profile 的 `order` 并反映到侧边栏（跨分组拖拽会同步更新 `group` + `order`）。
- 分组批量固定：设置页支持一键将某个分组下的所有应用固定到侧边栏，并支持一键取消固定（批量设置 `pinned=true/false` 并分配 `order`）。
- 应用编辑体验：设置页“添加/编辑 Web 应用”使用页内表单替换当前列表视图（不使用弹窗），并提供返回按钮回到列表。
- 侧边栏滚动条：侧边栏应用列表可滚动，但默认隐藏滚动条（仍可通过鼠标滚轮/触控板滚动）。
- 快捷键：主应用菜单需包含 `Edit` 常用 role（copy/paste/undo/redo/selectAll 等），否则 macOS 下复制/粘贴快捷键可能不生效。

### Key Entities *(include if feature involves data)*

- **Web 应用（Web App Profile）**: 用户添加的一个 Web 应用配置（名称、入口 URL、允许域名范围、隔离标识、最近使用信息等）
- **应用库（App Library）**: 用户已添加 Web 应用的集合与管理入口
- **工作区（Workspace）**: 当前打开的 Web 应用集合、当前活跃应用、每个应用的最后可见状态摘要

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户在 60 秒内可完成新增一个 Web 应用并成功打开
- **SC-002**: 在已打开 3 个 Web 应用的情况下，用户切换到任意一个应用时，90% 的切换在 1 秒内恢复到可交互状态
- **SC-003**: 对于需要登录的 Web 应用，在同一次运行内来回切换 10 次后，至少 95% 的情况下仍保持登录态（不要求覆盖所有第三方站点的异常策略）
- **SC-004**: 不同 Web 应用之间不发生会话/登录串号：通过“同一服务的两个不同账号分别登录在两个 Web 应用中”进行验证，切换后账号不互相影响
- **SC-005**: 用户退出并重新启动应用后，可恢复到上次活跃 Web 应用；至少 90% 的情况下恢复到用户退出前的页面或等价状态
