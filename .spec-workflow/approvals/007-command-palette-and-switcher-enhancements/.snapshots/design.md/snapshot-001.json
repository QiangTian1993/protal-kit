{
  "id": "snapshot_1767533532939_4pxbr2y3s",
  "approvalId": "approval_1767533532928_0i25e8whr",
  "approvalTitle": "审批设计文档：CommandPalette 与 Switcher 交互增强",
  "version": 1,
  "timestamp": "2026-01-04T13:32:12.939Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\n本设计围绕两个高频入口进行增强：`CommandPalette`（全局命令面板）与 `Switcher`（侧边栏切换器），并补齐与 `LibraryView`（应用库管理）之间的承接能力，目标是减少“切换/管理”分离导致的操作绕路，同时提升可发现性与搜索确认效率喵～\n\n范围内改动集中在渲染进程 UI 与少量主进程 IPC/事件广播；尽量复用现有 Profile CRUD、设置抽屉（BrowserView）与模糊搜索能力，保持实现简洁（KISS）且克制（YAGNI）。\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n当前项目未提供 `.spec-workflow/steering/tech.md`，本设计遵循现有技术栈与约定：\n- TypeScript 严格模式，避免 `any`\n- React 组件保持职责单一，拆分可复用 UI 单元\n- IPC 通道统一经 `window.portalKit.invoke`，事件广播统一经 `window.portalKit.on` 白名单\n- 输入校验与错误反馈采用“非阻塞提示 + 不崩溃”的可靠性策略\n\n### Project Structure (structure.md)\n当前项目未提供 `.spec-workflow/steering/structure.md`，本设计遵循现有目录结构：\n- 渲染进程：`src/renderer/components/`（通用 UI）、`src/renderer/features/`（功能模块）、`src/renderer/lib/ipc/`（IPC 封装）、`src/renderer/utils/`（纯工具）\n- 主进程：`src/main/ipc/handlers/`（IPC handlers）、`src/main/windows/`（BrowserView 管理）\n- 预加载：`src/preload/ipc-bridge.ts`（事件白名单）\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **`src/renderer/components/CommandPalette.tsx`**：在现有“搜索并切换 Profile”的基础上扩展为“命令+应用”统一面板\n- **`src/renderer/utils/fuzzySearch.ts`**：复用既有排序/匹配逻辑；扩展为可返回匹配位置用于高亮\n- **`src/renderer/features/switcher/Switcher.tsx`**：在现有拖拽与分组基础上增加右键入口与拖拽反馈\n- **`src/renderer/features/library/LibraryView.tsx`**：复用既有 create/edit/reveal 逻辑；增加“外部导航请求”的承接能力\n- **`src/renderer/features/library/ProfileForm.tsx`**：复用 Profile 创建/编辑表单（用于“创建应用”快捷入口）\n- **`src/renderer/lib/ipc/profiles.ts`**：复用 create/update/batchUpdate 等 IPC\n- **`src/renderer/lib/ipc/settings.ts`**：复用打开/关闭设置抽屉\n- **`src/main/windows/settings-window.ts`**：复用设置抽屉 BrowserView；补充“向设置抽屉发送导航指令”的能力\n\n### Integration Points\n- **IPC（主进程）**：新增 `app.settings.navigate`（或等价命名）用于“打开设置抽屉并导航到 LibraryView 的指定位置”\n- **事件广播（预加载白名单）**：新增 `ui.library.navigate` 事件通道，让 SettingsApp/LibraryView 接收导航请求\n- **Profile 数据层**：继续使用 `profiles.create / profiles.update / profiles.batchUpdate`，不引入新的存储结构\n\n## Architecture\n\n### 关键设计决策\n\n1) **CommandPalette 结果模型统一化**  \n将“应用结果（Profile）”与“命令结果（Command）”抽象为统一的 `PaletteItem` 列表，统一键盘导航与渲染入口，避免两套逻辑分叉（DRY）。\n\n2) **上下文菜单优先使用渲染进程自绘**  \n`Switcher` 的右键菜单采用 React 自绘弹层（定位到鼠标坐标），以减少主进程 Menu 依赖与跨平台差异；菜单项执行通过既有 IPC 与新增 settings 导航 IPC 完成。\n\n3) **Settings 抽屉导航采用“主进程中转 + 事件广播”**  \n主窗口渲染进程无法直接访问设置抽屉 BrowserView 的 webContents，因此新增 `app.settings.navigate` IPC：主进程负责 `settingsWindow.open()` 并向设置抽屉发送 `ui.library.navigate` 事件。SettingsApp 监听并驱动 LibraryView 更新。\n\n```mermaid\nflowchart TD\n  A[Main Window Renderer] -->|invoke app.settings.navigate| B[Main Process IPC Handler]\n  B --> C[SettingsWindowManager.open()]\n  B -->|send ui.library.navigate| D[Settings Drawer WebContents]\n  D --> E[SettingsApp]\n  E --> F[LibraryView]\n```\n\n### 模块拆分（建议）\n\n- `src/renderer/components/CommandPalette.tsx`：保持为 UI 组件 + 轻业务编排\n- `src/renderer/utils/palette.ts`（新增）：命令注册/过滤/合并/高亮所需的纯函数工具\n- `src/renderer/components/ContextMenu.tsx`（新增）：通用自绘右键菜单（Switcher 可复用）\n- `src/renderer/components/HighlightText.tsx`（新增）：根据匹配索引渲染高亮片段\n- `src/renderer/lib/ipc/settings-navigate.ts`（新增）：封装 `app.settings.navigate` 调用\n\n> 注：以上新增文件可按实现复杂度裁剪；若代码量很小，也可先内联在 `CommandPalette`/`Switcher` 中，后续再抽取（KISS 优先）。\n\n## Components and Interfaces\n\n### 1) CommandPalette：统一条目模型\n\n**Purpose:** 在一个面板中同时完成“切换应用 / 执行动作 / 创建应用”。\n\n**Interfaces:**\n\n```ts\ntype PaletteItem =\n  | { type: 'profile'; id: string; profileId: string }\n  | { type: 'command'; id: string; commandId: string }\n  | { type: 'createProfile'; id: string; suggestedName: string; suggestedUrl?: string }\n\ntype CommandDescriptor = {\n  id: string\n  title: string\n  keywords?: string[]\n  section?: '应用' | '动作' | '创建'\n  run: () => Promise<void> | void\n}\n```\n\n**Dependencies:** `fuzzySearch`（或其扩展版）、`switchProfile`、`openSettingsWindow`、`createProfile`、主题/布局等现有 IPC。\n\n**Reuses:** `SearchInput`、现有 CommandPalette Item UI、`ProfileFormModal`（用于创建）。\n\n**行为要点：**\n- 查询为空：显示“最近使用（可选）+ 常用命令（可选）”\n- 查询非空：返回命令与应用的混合结果（可按 section 分组渲染）\n- 无匹配：展示 “创建应用：{query}”\n\n### 2) HighlightText：匹配高亮\n\n**Purpose:** 渲染名称/URL 的匹配高亮，降低识别成本。\n\n**Interfaces:**\n\n```ts\ntype MatchRange = { start: number; end: number } // [start, end)\n\nfunction computeMatchRanges(text: string, query: string): MatchRange[]\n```\n\n**策略：**\n- 优先使用模糊匹配得到的“命中索引”计算 ranges（subsequence）\n- 若无法获取索引，则对连续子串命中进行高亮（case-insensitive）\n\n### 3) SwitcherContextMenu：右键菜单\n\n**Purpose:** 为高频对象提供就地管理入口：编辑/固定/定位到库。\n\n**Interfaces:**\n\n```ts\ntype SwitcherMenuAction = 'edit' | 'togglePinned' | 'revealInLibrary'\n```\n\n**交互要点：**\n- 右键打开菜单时必须 `preventDefault()`，并阻止触发切换点击\n- 菜单关闭条件：ESC / 点击外部\n- 执行动作后默认关闭菜单\n\n### 4) LibraryView：承接外部导航\n\n**Purpose:** 支持从 `Switcher`/`CommandPalette` 直接进入编辑页或列表定位。\n\n**Interfaces（建议）：**\n\n```ts\ntype LibraryNavigatePayload =\n  | { mode: 'edit'; profileId: string }\n  | { mode: 'reveal'; profileId: string }\n```\n\nSettingsApp 监听 `ui.library.navigate`，将 payload 传入 LibraryView（或由 SettingsApp 直接调用 LibraryView 的公开方法/状态）。\n\n## Data Models\n\n### 1) Settings 导航事件（跨 BrowserView）\n\n**Event Channel:** `ui.library.navigate`\n\n**Payload:**\n```ts\ntype LibraryNavigatePayload =\n  | { mode: 'edit'; profileId: string }\n  | { mode: 'reveal'; profileId: string }\n```\n\n### 2) Settings 导航 IPC（渲染→主进程）\n\n**Invoke Channel:** `app.settings.navigate`\n\n**Payload:**\n```ts\n{ requestId: string; target: 'library'; payload: LibraryNavigatePayload }\n```\n\n**返回：**\n```ts\n{ requestId: string; result: { navigated: boolean } }\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **创建应用 URL 非法**\n   - **Handling:** 阻止提交并在表单内展示校验提示\n   - **User Impact:** 用户看到明确错误原因，不会产生无效 Profile\n\n2. **打开设置抽屉失败 / 导航事件发送失败**\n   - **Handling:** 捕获异常并提示“打开设置失败”；不影响当前窗口继续使用\n   - **User Impact:** 操作未完成但应用不崩溃\n\n3. **目标 profileId 不存在（已被删除或未同步）**\n   - **Handling:** SettingsApp/LibraryView 回退到列表页，并提示“未找到该应用”\n   - **User Impact:** 仍能继续管理其他应用\n\n4. **拖拽排序与点击误触冲突**\n   - **Handling:** 延续现有 `ignoreClickUntil` 机制；拖拽期间禁用点击切换\n   - **User Impact:** 避免误切换造成“状态丢失”的错觉\n\n## Testing Strategy\n\n### Unit Testing\n- `computeMatchRanges()`：覆盖连续子串与模糊索引两种路径\n- “命令与 profile 合并排序”纯函数：保证结果稳定、可预测\n\n### Integration Testing\n- CommandPalette：输入 → 结果渲染 → 键盘选择 → 执行动作（使用 vitest + react testing 方案；若现有项目无相关测试框架可先跳过）\n- Settings 导航：`app.settings.navigate` IPC handler 的输入校验与调用链路\n\n### End-to-End Testing\n- Playwright：模拟 `Cmd/Ctrl+K` → 选择命令“打开设置” → 进入编辑指定 Profile → 保存后回到 Switcher 可见更新\n\n",
  "fileStats": {
    "size": 9180,
    "lines": 210,
    "lastModified": "2026-01-04T13:31:49.538Z"
  },
  "comments": []
}