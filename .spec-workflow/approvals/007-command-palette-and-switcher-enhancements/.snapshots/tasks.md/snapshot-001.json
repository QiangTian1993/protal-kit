{
  "id": "snapshot_1767533709981_rirdmc45g",
  "approvalId": "approval_1767533709973_4duuzpx2u",
  "approvalTitle": "审批任务清单：CommandPalette 与 Switcher 交互增强",
  "version": 1,
  "timestamp": "2026-01-04T13:35:09.981Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks Document\n\n- [ ] 1. 扩展 preload 事件白名单支持 Library 导航\n  - File: src/preload/ipc-bridge.ts\n  - 添加 `ui.library.navigate` 到 `allowedEventChannels`\n  - Purpose: 允许设置抽屉（BrowserView）安全接收“编辑/定位到库”的导航事件\n  - _Leverage: src/preload/ipc-bridge.ts（现有 allowedEventChannels 模式）_\n  - _Requirements: 6_\n  - _Prompt: 角色：Electron 安全工程师 | 任务：在不扩大攻击面的前提下扩展 preload 事件白名单以支持 Library 导航事件 | 限制：只能新增必要的事件通道；不得放宽白名单策略；不得引入 remote/Node API 暴露 | 验收：新增事件可被 SettingsApp 接收，且其他未白名单事件仍会抛错_\n\n- [ ] 2. 新增 Settings 导航 IPC（渲染→主进程）\n  - File: src/main/ipc/handlers/app.ts\n  - 新增 `app.settings.navigate` handler：打开设置抽屉并转发 `ui.library.navigate` 到设置抽屉 webContents\n  - Purpose: 让主窗口渲染进程能触发“打开设置并直达 LibraryView 指定位置”\n  - _Leverage: src/main/ipc/handlers/app.ts（现有 app.settings.open/close 处理器风格）, src/main/windows/settings-window.ts（BrowserView 管理）_\n  - _Requirements: 6_\n  - _Prompt: 角色：Electron 主进程工程师 | 任务：实现 app.settings.navigate IPC，保证在设置抽屉已加载/未加载两种情况下都能可靠送达导航事件 | 限制：必须校验 payload；不得造成主进程崩溃；不得阻塞 UI 线程 | 验收：调用后设置抽屉打开并收到导航事件；重复调用不会失效_\n\n- [ ] 3. 为 SettingsWindowManager 增加“向抽屉发送事件”的能力（含送达保障）\n  - File: src/main/windows/settings-window.ts\n  - 增加 `sendToDrawer(channel, payload)` 或 `navigateToLibrary(payload)` 方法\n  - 增加“未加载时缓存、加载完成后发送”的送达保障（例如使用 `did-finish-load`）\n  - Purpose: 解决 BrowserView 未就绪导致事件丢失的问题\n  - _Leverage: src/main/windows/settings-window.ts（现有 view 生命周期与 open/close 模式）_\n  - _Requirements: 6_\n  - _Prompt: 角色：Electron 工程师 | 任务：在 SettingsWindowManager 内实现可靠的消息送达机制（支持首次加载与重复打开），并提供给 IPC handler 调用 | 限制：不得频繁 reload；不得引入全局状态污染；保持类职责单一 | 验收：首次打开设置抽屉时导航事件不丢；后续多次导航也可立即生效_\n\n- [ ] 4. SettingsApp 监听导航事件并驱动 LibraryView 承接\n  - File: src/renderer/app/SettingsApp.tsx\n  - 监听 `window.portalKit.on('ui.library.navigate', ...)` 并将导航请求交给 LibraryView（通过 props 或本地状态）\n  - Purpose: 将跨 BrowserView 的导航请求落到实际 UI 状态变更\n  - _Leverage: src/renderer/app/SettingsApp.tsx（现有 ui.language.changed 监听方式）, src/renderer/features/library/LibraryView.tsx（现有 screen 状态模型）_\n  - _Requirements: 6_\n  - _Prompt: 角色：React 工程师 | 任务：在 SettingsApp 中安全订阅并清理导航事件监听，保证事件到达时能驱动 LibraryView 切屏/定位 | 限制：避免引入不可控的全局状态；确保 effect cleanup 正确 | 验收：触发导航事件后能进入 edit 或 reveal；关闭窗口后监听不泄漏_\n\n- [ ] 5. LibraryView 支持“edit/reveal”外部导航与定位高亮\n  - File: src/renderer/features/library/LibraryView.tsx\n  - 增加可选 props（例如 `navigate?: { mode: 'edit'|'reveal'; profileId: string; nonce: string }`）\n  - 实现：`edit` 直接进入编辑页；`reveal` 回到列表页、清空搜索、滚动定位并短暂高亮目标项\n  - Purpose: 打通 Switcher/CommandPalette → LibraryView 的“就地管理”路径\n  - _Leverage: src/renderer/features/library/LibraryView.tsx（现有 screen/query/drag 状态）, src/renderer/utils/profileReorder.ts（现有分组逻辑）_\n  - _Requirements: 6, 4_\n  - _Prompt: 角色：前端工程师 | 任务：为 LibraryView 增加外部导航承接而不破坏现有管理能力（创建/编辑/删除/拖拽/分组） | 限制：不引入新依赖；保持组件可维护；对不存在 profileId 需友好回退 | 验收：edit/reveal 均可用；不影响原有库管理功能_\n\n- [ ] 6. 新增通用 ContextMenu 组件（自绘右键菜单）\n  - File: src/renderer/components/ContextMenu.tsx\n  - 支持：按坐标定位、ESC/点击外部关闭、菜单项点击回调、基础可访问性属性\n  - Purpose: 为 Switcher 右键菜单提供可复用实现（后续也可复用于 Library 列表项等）\n  - _Leverage: src/renderer/components/Modal.tsx（现有遮罩/弹层交互风格）, src/renderer/styles.css（现有视觉变量）_\n  - _Requirements: 4_\n  - _Prompt: 角色：React UI 工程师 | 任务：实现轻量 ContextMenu，不依赖第三方库，交互符合桌面直觉 | 限制：组件职责单一；不引入全局事件泄漏；样式保持与现有设计一致 | 验收：右键可打开，ESC/点击外部可关闭，点击菜单项触发回调并关闭_\n\n- [ ] 7. Switcher 集成右键菜单并实现“编辑/固定/定位到库”\n  - File: src/renderer/features/switcher/Switcher.tsx\n  - 在按钮上添加 `onContextMenu`：打开 ContextMenu 并绑定 profileId\n  - 动作实现：\n    - 编辑：调用 `app.settings.navigate`（open + edit）\n    - 在库中显示：调用 `app.settings.navigate`（open + reveal）\n    - 固定/取消固定：复用 `profiles.update`（或 batchUpdate）更新 pinned 状态\n  - 处理：右键打开后不触发切换；菜单关闭不影响现有拖拽逻辑\n  - Purpose: 提升 Switcher 管理能力与可发现性\n  - _Leverage: src/renderer/features/switcher/Switcher.tsx（现有拖拽/ignoreClickUntil）, src/renderer/lib/ipc/profiles.ts, src/renderer/lib/ipc/settings.ts_\n  - _Requirements: 4, 6_\n  - _Prompt: 角色：前端工程师 | 任务：在不破坏拖拽排序与切换逻辑的前提下，为 Switcher 增加上下文菜单与快捷操作 | 限制：确保右键与拖拽/点击互斥；异常要被捕获并友好提示 | 验收：右键菜单动作可用；拖拽/点击行为保持稳定_\n\n- [ ] 8. 增强 Switcher 拖拽可发现性与反馈\n  - File: src/renderer/features/switcher/Switcher.tsx, src/renderer/styles.css\n  - 增加 hover 提示（如拖拽手柄/轻提示）与拖拽落点反馈（更明显的高亮/指示）\n  - Purpose: 降低新用户学习成本，减少误操作\n  - _Leverage: src/renderer/styles.css（已有 .isDragOver/.isDragging 样式）, src/renderer/features/switcher/Switcher.tsx（已有拖拽状态）_\n  - _Requirements: 5_\n  - _Prompt: 角色：UI/UX 工程师 | 任务：增强拖拽的可发现性与反馈，保持视觉克制且不干扰内容 | 限制：不引入新依赖；保持性能；样式需适配深色模式 | 验收：用户悬停即可感知可拖拽；拖拽过程中落点清晰；无明显掉帧_\n\n- [ ] 9. CommandPalette 引入“命令注册表”并支持命令搜索与执行\n  - File: src/renderer/components/CommandPalette.tsx, src/renderer/app/App.tsx（必要时）\n  - 新增命令模型 `CommandDescriptor`，并在面板内与 Profile 结果合并\n  - 初始命令建议（可精简）：打开设置、切换侧边栏、切换沉浸模式、循环主题模式\n  - Purpose: 将 CommandPalette 从“搜索应用”升级为“命令面板”\n  - _Leverage: src/renderer/components/CommandPalette.tsx（现有键盘导航/列表渲染）, src/renderer/lib/ipc/settings.ts, src/renderer/lib/ipc/theme.ts, src/renderer/app/App.tsx（现有 sidebar/immersive 状态）_\n  - _Requirements: 1_\n  - _Prompt: 角色：前端工程师 | 任务：实现最小可用命令面板（命令+应用合并搜索、键盘执行），并保持组件结构清晰 | 限制：避免过度抽象；命令集先做高频小集合；错误要可见但不打断 | 验收：可搜索并执行命令；可继续搜索并切换应用；键盘导航稳定_\n\n- [ ] 10. CommandPalette 支持“创建应用”快捷入口（无匹配时）\n  - File: src/renderer/components/CommandPalette.tsx\n  - 无匹配时展示“创建应用：{query}”\n  - 选择后弹出创建表单（优先复用 `ProfileFormModal`，并将 query 用作默认 name/或 URL 推断）\n  - 创建成功后：默认固定到侧边栏，并可选自动切换到新建应用\n  - Purpose: 缩短“搜索→创建→使用”的路径\n  - _Leverage: src/renderer/features/library/ProfileForm.tsx（ProfileFormModal）, src/renderer/lib/ipc/profiles.ts（createProfile）, src/renderer/lib/ipc/workspace.ts（switchProfile）_\n  - _Requirements: 2_\n  - _Prompt: 角色：前端工程师 | 任务：在 CommandPalette 内加入创建入口并复用既有 Profile 表单与 IPC，保证校验与错误反馈清晰 | 限制：不复制整套库管理逻辑；创建流程应可取消；URL 必须校验 | 验收：无匹配时可创建；创建后 Switcher 可见；切换行为符合预期_\n\n- [ ] 11. 搜索结果高亮：扩展 fuzzySearch 返回匹配位置并渲染高亮\n  - File: src/renderer/utils/fuzzySearch.ts, src/renderer/components/CommandPalette.tsx（以及新增高亮组件如需要）\n  - 扩展模糊匹配算法，输出命中索引（或 ranges）用于 UI 高亮\n  - 渲染层高亮名称与 URL 的命中片段；无法定位时回退到连续子串高亮\n  - Purpose: 提升搜索确认效率，降低误选风险\n  - _Leverage: src/renderer/utils/fuzzySearch.ts（现有 calculateFuzzyScore 思路）, src/renderer/components/CommandPalette.tsx（现有结果列表）_\n  - _Requirements: 3_\n  - _Prompt: 角色：TypeScript 工具函数工程师 | 任务：在保持性能的前提下让 fuzzySearch 可输出匹配位置，并在 UI 中可视化高亮 | 限制：避免引入复杂依赖；对 Unicode 处理保持稳健；在 500 profiles 下输入响应流畅 | 验收：高亮准确；搜索排序不回退；无明显卡顿_\n\n- [ ] 12. 补充单元测试与手动验收清单\n  - File: tests（新增/修改），以及必要的 quickstart 文档（可选）\n  - 为匹配高亮/索引计算添加 vitest 单测\n  - 增加手动验收步骤：右键菜单、编辑/定位承接、创建应用、键盘导航\n  - Purpose: 降低回归风险，保证交互一致性\n  - _Leverage: vitest.config.ts, tests/（现有测试结构）_\n  - _Requirements: 1, 2, 3, 4, 5, 6_\n  - _Prompt: 角色：测试工程师 | 任务：为关键纯函数与高风险交互补测试与验收步骤，覆盖成功/失败路径 | 限制：不做过度 E2E；优先测试可稳定自动化的部分 | 验收：单测可运行；验收清单可复现关键路径_\n\n",
  "fileStats": {
    "size": 10707,
    "lines": 111,
    "lastModified": "2026-01-04T13:34:46.389Z"
  },
  "comments": []
}